#! /usr/bin/env ruby
def system_log(str)
  puts str
  system(str)
end

if ARGV.length == 1
  info = "#{ARGV[0]}.txt"
  input = "#{ARGV[0]}.wav"
  output_dir = "~/Desktop/#{ARGV[0]}"
else
  info = ARGV[0]
  input = ARGV[1]
  output_dir = ARGV[2]
end

[info, input].map {|path|
  if !File.exists?(path || "")
    puts "** USAGE: info input output_dir"
    puts "** bad path '#{path}'"
    exit
  end
}


file = File.open(info, "r")

entries = Dir.entries(File.expand_path(output_dir)) rescue []
if !entries.empty?
  puts entries
  puts "#{output_dir} is not empty (contents listed above)"
  puts "would you like to remove them [Y/n]"
  response = (STDIN.gets).chomp
  if response == 'Y'
    system_log("rm -rf #{output_dir}")
  else
    exit
  end
end

system_log "mkdir #{output_dir}"

commands = file.read.split("\n").each_with_index.map do |line, index|
  line = line.split(" ")
  track_name = line[0]
  start_time = line[1]
  end_time = line[2]
  track_number = "%.2d" % (index + 1)
  basename = File.basename(output_dir)
  file_name="#{output_dir}/#{basename}.t#{track_number}.#{track_name}.wav"
  fork {
    system_log("sox #{input} #{file_name} trim #{start_time} \\=#{end_time} norm fade q 2 0 6")
  }
end
Process.waitall
